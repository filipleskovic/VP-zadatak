<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css">
    <title>Projektni zadatak</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
     
    </style>
  </head>
  <body>
    <div class="row">
        <div id="tooltip" class="tooltip"></div>
      <svg id="map"></svg>
      <script>
        var activeApartmant = null
        var weekends = []
        var weekdays = []
        var weekdaysAll=[]
        var weekendsAll=[]
        function findMatchingWeekdayPrice(lat, lng) {
            const weekdayObj = weekdays.find(
              (obj) => obj.lat === lat && obj.lng === lng
            );

            if (!weekdayObj) {
              return 0;
            }

            return weekdayObj.realSum;
        }
        function findMatchingWeekendPrice(lat, lng) {
            const weekendObj = weekends.find(
              (obj) => obj.lat === lat && obj.lng === lng
            );

            if (!weekendObj) {
              return 0;
            }

            return weekendObj.realSum;
        }
        function openDetails(content) {
          d3.select("#details-body").html(content);
          d3.select("#details").style("display", "block");
        }
        function closeDetais() {
          d3.select("#details").style("display", "none");
        }
        function manageWeekends() {
          const flag = document.getElementById("weekendsCheckbox");
          if (flag.checked) {
            d3.selectAll(".circle-weekends").style("display", "block");
          } else {
            d3.selectAll(".circle-weekends").style("display", "none");
          }
        }
        function manageWeekdays() {
          const flag = document.getElementById("weekdaysCheckbox");
          if (flag.checked) {
            d3.selectAll(".circle-weekdays").style("display", "block");
          } else {
            d3.selectAll(".circle-weekdays").style("display", "none");
          }
        }
        

        const width = 800;
        const height = 300;

        const svg = d3.select("#map").attr("width", 1200)
.attr("height", 800);
        const g = svg.append("g");
        const gWeekends = svg.append("g").attr("class", "weekends");
        const gWeekdays = svg.append("g").attr("class", "weekdays");


        function drawPriceChart(data, selectedApartment) {
          const container = d3.select("#graph-body");
          container.selectAll("*").remove();

          container.append("h4").text("Cijene u odnosu na ostale:");

          const svgWidth = 600;
          const svgHeight = 400;
          const margin = { top: 20, right: 30, bottom: 40, left: 50 };

          const svg = container
            .append("svg")
            .attr("id", "priceChart")
            .attr("width", svgWidth)
            .attr("height", svgHeight);

          const width = svgWidth / 2; // polovina širine za prvi graf
          const height = svgHeight;

          let selectedPrice = 0;
          const prices = data.map(d => parseFloat(d.realSum)).filter(p => !isNaN(p));
          if (selectedApartment !== null) {
            selectedPrice = parseFloat(selectedApartment.realSum);
          }

          const minPrice = d3.min(prices);
          const maxPrice = d3.max(prices);
          const avgPrice = d3.mean(prices);

          const chartData = [
            { category: "Minimalna", value: minPrice },
            { category: "Prosječna", value: avgPrice },
            { category: "Maksimalna", value: maxPrice },
            { category: "Odabrani", value: selectedPrice }
          ];

          const x0 = d3.scaleBand()
            .domain(chartData.map(d => d.category))
            .range([margin.left, width - margin.right])
            .padding(0.3);

          const y = d3.scaleLinear()
            .domain([0, maxPrice * 1.1])
            .range([height - margin.bottom, margin.top]);

          // x-os
          svg.append("g")
            .attr("class", "axis x-axis")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x0));

          // y-os
          svg.append("g")
            .attr("class", "axis y-axis")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(y))
            .selectAll("text")
            .attr("dx", "-10")

          // barovi
          svg.selectAll(".bar")
            .data(chartData)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", d => x0(d.category))
            .attr("y", d => y(d.value))
            .attr("width", x0.bandwidth())
            .attr("height", d => height - margin.bottom - y(d.value))
            .attr("fill", d => d.category === "Odabrani" ? "orange" : "steelblue");

          svg.selectAll(".label")
            .data(chartData)
            .enter()
            .append("text")
            .attr("class", "label")
            .attr("x", d => x0(d.category) + x0.bandwidth() / 2)
            .attr("y", d => y(d.value) - 5)
            .attr("text-anchor", "middle")
            .text(d => d.value.toFixed(0) + " €");
        }
        function applyFilter (e){

            e.preventDefault(); 
            const minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
            const maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;
            const capacity = parseFloat(document.getElementById("capacity").value) || 0;
            const roomType = document.getElementById("roomType").value;
            const filteredDataWeekend = weekendsAll.filter((d) => {
              const price = parseFloat(d.realSum);
              const matchesPrice = price >= minPrice && price <= maxPrice;
              const matchesRoom = roomType ? d.room_type === roomType : true;
              var matchesCapacity
              if(capacity===0)
              {
              matchesCapacity = true
              }
              else
              {
              matchesCapacity = parseInt(d.person_capacity) === capacity
              }
              return matchesPrice && matchesRoom && matchesCapacity;
            });
            const filteredDataWeekday = weekdaysAll.filter((d) => {
              const price = parseFloat(d.realSum);
              const matchesPrice = price >= minPrice && price <= maxPrice;
              const matchesRoom = roomType ? d.room_type === roomType : true
              var matchesCapacity
              if(capacity===0)
              {
              matchesCapacity = true
              }
              else
              {
              matchesCapacity = parseInt(d.person_capacity) === capacity
              }
              return matchesPrice && matchesRoom && matchesCapacity;
            });
              const combinedData = [...filteredDataWeekend, ...filteredDataWeekday];
              weekdays=filteredDataWeekday
              weekends=filteredDataWeekend
              drawPriceChart(combinedData, activeApartmant); 

            const weekendsChecked = document.getElementById("weekendsCheckbox").checked;
              g.selectAll(".circle-weekends").remove();
              g.selectAll("gWeekends")
                .data(filteredDataWeekend)
                .enter()
                .append("circle")
                .attr("class", "circle-weekends")
                .attr("cx", (d) => projection([+d.lng, +d.lat])[0])
                .attr("cy", (d) => projection([+d.lng, +d.lat])[1])
                .attr("r", 1.5)
                .attr("fill", "purple")
                .attr("opacity", 0.6)
                .style("cursor", "pointer")
                .on("mouseover", (event, d) => {
                  tooltip
                    .style("opacity", 1)
                    .html(`Cijena: €${parseFloat(d.realSum).toFixed(2)}`);
                })
                .on("mousemove", (event) => {
                  tooltip
                    .style("left", event.pageX + 10 + "px")
                    .style("top", event.pageY - 20 + "px");
                })
                .on("mouseout", () => {
                  tooltip.style("opacity", 0);
                })
                .on("click", (event, d) => {
                  drawPriceChart(weekends,d)
                  const content = `
                    <strong>Cijena:</strong> €${parseFloat(d.realSum).toFixed(2)}<br>
                    <strong>Tip:</strong> ${d.room_type}<br>
                    <strong>Ka  pacitet:</strong> ${parseInt(d.person_capacity)}<br>
                    <strong>Cijena preko tjedna:</strong> €${parseFloat(findMatchingWeekdayPrice(d.lat,d.lng)).toFixed(2)}<br>
                    <strong>Superhost:</strong> ${d.host_is_superhost === "True" ? "Da" : "Ne"}<br>
                    <strong>Ocjena gostiju:</strong> ${d.guest_satisfaction_overall}<br>
                    <strong>Posjeduje privatnu sobu:</strong> ${
                      d.room_private === "True" ? "Da" : "Ne"
                    }<br>
                  `;
                  openDetails(content);
                });
                g.selectAll(".circle-weekends")
                .style("display", weekendsChecked ? "inline" : "none");
              

              const weekdaysChecked = document.getElementById("weekdaysCheckbox").checked;
              
                  g.selectAll(".circle-weekdays").remove();
                  g.selectAll("gWeekdays")
                    .data(filteredDataWeekday)
                    .enter()
                    .append("circle")
                    .attr("class", "circle-weekdays")
                    .attr("cx", (d) => projection([+d.lng, +d.lat])[0])
                    .attr("cy", (d) => projection([+d.lng, +d.lat])[1])
                    .attr("r", 1.5)
                    .attr("fill", "orange")
                    .attr("opacity", 0.6)
                    .style("cursor", "pointer")
                    .on("mouseover", (event, d) => {
                      tooltip
                        .style("opacity", 1)
                        .html(`Cijena: €${parseFloat(d.realSum).toFixed(2)}`);
                    })
                    .on("mousemove", (event) => {
                      tooltip
                        .style("left", event.pageX + 10 + "px")
                        .style("top", event.pageY - 20 + "px");
                    })
                    .on("mouseout", () => {
                      tooltip.style("opacity", 0);
                    })
                    .on("click", (event, d) => {
                      activeApartmant=d
                      drawPriceChart(weekdays,activeApartmant)
                      const content = `
                          <strong>Cijena:</strong> €${parseFloat(d.realSum).toFixed(2)}<br>
                          <strong>Tip:</strong> ${d.room_type}<br>
                          <strong>Cijena preko vikenda:</strong>${parseFloat(findMatchingWeekendPrice(d.lat,d.lng)).toFixed(2)}<br>
                          <strong>Kapacitet:</strong> ${parseInt(d.person_capacity)}<br>
                          <strong>Superhost:</strong> ${d.host_is_superhost== "True" ? "Da" : "Ne"}<br>
                          <strong>Ocjena gostiju:</strong> ${d.guest_satisfaction_overall}<br>
                          <strong>Posjeduje privatnu sobu:</strong> ${
                            d.room_private === "True" ? "Da" : "Ne"
                          }<br>
                        `;
                      openDetails(content);
                    });
                    g.selectAll(".circle-weekdays").style("display", weekdaysChecked ? "inline" : "none");
              
                };         
        function resetFilter(e) {
          document.getElementById("filterForm").reset();
          document.getElementById("weekendsCheckbox").checked = false;
          document.getElementById("weekdaysCheckbox").checked = false;
          d3.select("#yourChartContainer").selectAll("*").remove(); 
          g.selectAll(".circle-weekends")
                .style("display","none");
          g.selectAll(".circle-weekends")
                .style("display","none");
          applyFilter(e);  

  }
        
        function drawRegionComparisonChart(regionWeekdays, regionWeekends) {
          const svg = d3.select("#priceChart"); 
          const svgWidth = +svg.attr("width");
          const svgHeight = +svg.attr("height");
          const margin = { top: 20, right: 30, bottom: 40, left: 50 };

          const offsetX = 170;; 

          svg.selectAll(".region-bar-group").remove();
          svg.selectAll(".region-axis").remove();
          svg.selectAll(".region-label").remove();

          const allPrices = [...regionWeekdays, ...regionWeekends]
            .map(d => parseFloat(d.realSum))
            .filter(p => !isNaN(p));

          if (allPrices.length === 0) return; 

          const chartData = [
            {
              category: "Minimalna",
              week: d3.min(regionWeekdays, d => parseFloat(d.realSum)) || 0,
              weekend: d3.min(regionWeekends, d => parseFloat(d.realSum)) || 0
            },
            {
              category: "Prosječna",
              week: d3.mean(regionWeekdays, d => parseFloat(d.realSum)) || 0,
              weekend: d3.mean(regionWeekends, d => parseFloat(d.realSum)) || 0
            },
            {
              category: "Maksimalna",
              week: d3.max(regionWeekdays, d => parseFloat(d.realSum)) || 0,
              weekend: d3.max(regionWeekends, d => parseFloat(d.realSum)) || 0
            }
          ];

          const x0 = d3.scaleBand()
            .domain(chartData.map(d => d.category))
            .range([offsetX, svgWidth - margin.right])
            .padding(0.3);

          const x1 = d3.scaleBand()
            .domain(["week", "weekend"])
            .range([0, x0.bandwidth()])
            .padding(0.1);

          const maxY = d3.max(chartData.flatMap(d => [d.week, d.weekend]));
          const y = d3.scaleLinear()
            .domain([0, maxY * 1.1])
            .range([svgHeight - margin.bottom, margin.top]);

          const color = {
            week: "orange",
            weekend: "green"
          };

          svg.append("g")
            .attr("class", "region-axis")
            .attr("transform", `translate(${offsetX+170}, 0)`) 
            .call(d3.axisLeft(y))
            .selectAll("text")
            .attr("dx", "-10");
          svg.append("g")
            .attr("class", "region-axis")
            .attr("transform", `translate(${offsetX}, ${svgHeight - margin.bottom})`)
            .call(d3.axisBottom(x0));
          const group = svg.append("g").attr("class", "region-bar-group").attr("transform", `translate(${offsetX}, 0)`);;

          const bars = group.selectAll("g")
            .data(chartData)
            .enter()
            .append("g")
            .attr("transform", d => `translate(${x0(d.category)},0)`);

          bars.selectAll("rect")
            .data(d => [
              { key: "week", value: d.week },
              { key: "weekend", value: d.weekend }
            ])
            .enter()
            .append("rect")
            .attr("x", d => x1(d.key))
            .attr("y", d => y(d.value))
            .attr("width", x1.bandwidth())
            .attr("height", d => svgHeight - margin.bottom - y(d.value))
            .attr("fill", d => color[d.key]);

          bars.selectAll("text")
            .data(d => [
              { key: "week", value: d.week },
              { key: "weekend", value: d.weekend }
            ])
            .enter()
            .append("text")
            .attr("class", "region-label")
            .attr("x", d => x1(d.key) + x1.bandwidth() / 2)
            .attr("y", d => y(d.value) - 5)
            .attr("text-anchor", "middle")
            .text(d => d.value.toFixed(0) + " €");
        }
        function RegionPriceChart(selectedRegion){
            const regionWeekdays= weekdaysAll.filter(function(d) {
            const point = [parseFloat(d.lng), parseFloat(d.lat)];
            return d3.geoContains(selectedRegion, point);
          });      
          const regionWeekends= weekendsAll.filter(function(d) {
            const point = [parseFloat(d.lng), parseFloat(d.lat)];
            return d3.geoContains(selectedRegion, point);
          });       
            console.log(regionWeekdays)
            console.log(regionWeekends)
            drawRegionComparisonChart(regionWeekdays, regionWeekends);
}
        const tooltip = d3.select("#tooltip");
        const projection = d3
         .geoMercator()
          .center([2.35, 48.86])
          .scale(150000)
          .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(projection);

        const zoom = d3
          .zoom()
          .scaleExtent([1, 20])
          .on("zoom", (event) => {
            g.attr("transform", event.transform);
          });
          
        svg.call(zoom);

        d3.json("paris.json").then((geojson) => {
          g.selectAll("path")
        .data(geojson.features)
        .enter()
        .append("path")
        .attr("d", path)
        .style("fill", "#cccccc") // koristi style zbog CSS-a
        .style("stroke", "#333")
        .style("stroke-width", "0.5px")
        .on("mouseover", function () {
          if (!d3.select(this).classed("clicked")) {
            d3.select(this)
              .style("fill", "#999999")
              .style("cursor", "pointer");
          }
        })
        .on("mouseout", function () {
          if (!d3.select(this).classed("clicked")) {
            d3.select(this)
              .style("fill", "#cccccc")
              .style("cursor", "default");
          }
        })
        .on("click", function (event,d) {
          // Reset svih regija: ukloni klasu i boju
          g.selectAll("path")
            .classed("clicked", false)
            .style("fill", "#cccccc");
          RegionPriceChart(d)

          // Kliknuta regija dobija novu boju i klasu
          d3.select(this)
            .classed("clicked", true)
            .style("fill", "#666666");
        });
          g.selectAll("text")
            .data(geojson.features)
            .enter()
            .append("text")
            .attr("transform", (d) => {
              const centroid = path.centroid(d);
              return `translate(${centroid})`;
            })
            .text((d) => d.properties.name?.toLowerCase() || "")
            .style("font-size", "7px");
        });

        d3.csv("paris_weekends.csv").then((data) => {
          weekends=data
          weekendsAll=data
          g.selectAll("gWeekends")
            .data(weekends)
            .enter()
            .append("circle")
            .attr("class", "circle-weekends")
            .attr("cx", (d) => projection([+d.lng, +d.lat])[0])
            .attr("cy", (d) => projection([+d.lng, +d.lat])[1])
            .attr("r", 1.5)
            .attr("fill", "purple")
            .attr("opacity", 0.6)
            .style("cursor", "pointer")
            .style("display", "none")
            .on("mouseover", (event, d) => {
              tooltip
                .style("opacity", 1)
                .html(`Cijena: €${parseFloat(d.realSum).toFixed(2)}`);
            })
            .on("mousemove", (event) => {
              tooltip
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 20 + "px");
            })
            .on("mouseout", () => {
              tooltip.style("opacity", 0);
            })
            .on("click", (event, d) => {
              var activeApartmant = d
              drawPriceChart(weekends,d)
              const content = `
        <strong>Cijena:</strong> €${parseFloat(d.realSum).toFixed(2)}<br>
        <strong>Tip:</strong> ${d.room_type}<br>
        <strong>Cijena preko tjedna:</strong>${parseFloat(findMatchingWeekendPrice(d.lat,d.lng)).toFixed(2)}<br>
        <strong>Kapacitet:</strong> ${parseInt(d.person_capacity)}<br>
        <strong>Superhost:</strong> ${d.host_is_superhost== "True" ? "Da" : "Ne"}<br>
        <strong>Ocjena gostiju:</strong> ${d.guest_satisfaction_overall}<br>
        <strong>Posjeduje privatnu sobu:</strong> ${
          d.room_private === "True" ? "Da" : "Ne"
        }<br>
      `;
              openDetails(content);
            });
        });
        d3.csv("paris_weekdays.csv").then((data) => {
          weekdays=data
          weekdaysAll=data
          g.selectAll("gWeekdays")
            .data(weekdays)
            .enter()
            .append("circle")
            .attr("class", "circle-weekdays")
            .attr("cx", (d) => projection([+d.lng, +d.lat])[0])
            .attr("cy", (d) => projection([+d.lng, +d.lat])[1])
            .attr("r", 1.5)
            .attr("fill", "orange")
            .attr("opacity", 0.6)
            .style("cursor", "pointer")
            .style("display", "none")
            .on("mouseover", (event, d) => {
              tooltip
                .style("opacity", 1)
                .html(`Cijena: €${parseFloat(d.realSum).toFixed(2)}`);
            })
            .on("mousemove", (event) => {
              tooltip
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 20 + "px");
            })
            .on("mouseout", () => {
              tooltip.style("opacity", 0);
            })
            .on("click", (event, d) => {
              var activeApartmant = d
              drawPriceChart(weekdays,activeApartmant)
              const content = `
        <strong>Cijena:</strong> €${parseFloat(d.realSum).toFixed(2)}<br>
        <strong>Tip:</strong> ${d.room_type}<br>
        <strong>Cijena preko vikenda:</strong>${parseFloat(findMatchingWeekendPrice(d.lat,d.lng)).toFixed(2)}<br>
        <strong>Kapacitet:</strong> ${parseInt(d.person_capacity)}<br>
        <strong>Superhost:</strong> ${d.host_is_superhost== "True" ? "Da" : "Ne"}<br>
        <strong>Ocjena gostiju:</strong> ${d.guest_satisfaction_overall}<br>
        <strong>Posjeduje privatnu sobu:</strong> ${
          d.room_private === "True" ? "Da" : "Ne"
        }<br>
      `;
              openDetails(content);
            });
        });
        
        d3.csv("hospital.csv").then((data) => {
          const hospitals = g
            .selectAll("g.hospital")
            .data(data)
            .enter()
            .append("g")
            .attr("class", "hospital")
            .attr("transform", (d) => {
              const [x, y] = projection([+d.longitude, +d.latitude]);
              return `translate(${x},${y})`;
            })
            .on("mouseover", (event, d) => {
              tooltip
                .style("opacity", 1)
                .html(`<strong>${d.name}</strong><br>${d.address}`);
            })
            .on("mousemove", (event) => {
              tooltip
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 20 + "px");
            })
            .on("mouseout", () => {
              tooltip.style("opacity", 0);
            });
          hospitals
            .append("line")
            .attr("x1", -5)
            .attr("y1", 0)
            .attr("x2", 5)
            .attr("y2", 0)
            .attr("stroke", "red")
            .attr("stroke-width", 2)
            .attr("opacity", 0.6);

          hospitals
            .append("line")
            .attr("x1", 0)
            .attr("y1", -5)
            .attr("x2", 0)
            .attr("y2", 5)
            .attr("stroke", "red")
            .attr("stroke-width", 2)
            .attr("opacity", 0.6);
        });
        d3.csv("police.csv").then((data) => {
          const policeStations = g
            .selectAll("g.police")
            .data(data)
            .enter()
            .append("g")
            .attr("class", "police")
            .attr("transform", (d) => {
              const [x, y] = projection([+d.longitude, +d.latitude]);
              return `translate(${x},${y})`;
            })
            .on("mouseover", (event, d) => {
              tooltip
                .style("opacity", 1)
                .html(`<strong>${d.name}</strong><br>${d.address}`);
            })
            .on("mousemove", (event) => {
              tooltip
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 20 + "px");
            })
            .on("mouseout", () => {
              tooltip.style("opacity", 0);
            });

          policeStations
            .append("rect")
            .attr("x", -5)
            .attr("y", -5)
            .attr("width", 5)
            .attr("height", 5)
            .attr("fill", "blue")
            .attr("opacity", 0.6)
            .attr("stroke", "black")
            .attr("stroke-width", 1);
        });
      </script>
    <div>
      <div id="details" class="details">
        <button onclick="closeDetais()" class="close-btn">×</button>
        <h3>Detalji stana</h3>
        <div id="details-body">Odaberi stan za prikaz informacija.</div>
      </div>
      <div id="filters" class="filters">
        <input
          type="checkbox"
          id="weekendsCheckbox"
          name="weekendsCheckbox"
          value="weekendFlag"
          onclick="manageWeekends()"
        />
        <label for="weekendsCheckbox">Vikendi</label>
        <input
          type="checkbox"
          id="weekdaysCheckbox"
          name="weekdaysCheckbox"
          value="weekdayFlag"
          onclick="manageWeekdays()"
        />
        <label for="weekdaysCheckbox">Tjedan</label>
      </div>
      <div class="filter "id="filter">
        <form id="filterForm">
          <label>Minimalna cijena (€): <input type="number" id="minPrice" /></label>
          <label>Maksimalna cijena (€): <input type="number" id="maxPrice" /></label>
          <label>Kapacitet: <input type="number" id="capacity"/></label>
          <label>
            Tip sobe:
            <select id="roomType">
              <option value="">Sve</option>
              <option value="Entire home/apt">Cijeli stan</option>
              <option value="Private room">Privatna soba</option>
            </select>
          </label>
        <button type="button" id="applyFilter">Primijeni filter</button>
        <button type="button" id="resetFilter">Resetiraj filter</button>

        </form>
        <script>
                document.getElementById("applyFilter").addEventListener("click", applyFilter);
                document.getElementById("resetFilter").addEventListener("click",resetFilter);
        </script>
      </div>
    </div>
  </div>
  <div class="row">
      <div id="graph-body">
      </div>
  </div>
  </body>

</html>
